import telebot
import statistics
import numpy as np
from sklearn.linear_model import LinearRegression

TOKEN = "7271325054:AAEp3S1Jj15JUr-cWRX5ZK7pP359kgA8XKY"
bot = telebot.TeleBot(TOKEN)

user_data = {}

def predict_next(crash_history):
    X = np.array(range(len(crash_history))).reshape(-1, 1)
    y = np.array(crash_history).reshape(-1, 1)
    model = LinearRegression()
    model.fit(X, y)
    next_index = np.array([[len(crash_history)]])
    prediction = model.predict(next_index)[0][0]

    avg = sum(crash_history) / len(crash_history)
    std_dev = statistics.stdev(crash_history) if len(crash_history) > 1 else 0

    high_jump = crash_history[-1] >= 10
    low_streak = all(val < 2 for val in crash_history[-3:])

    if prediction >= 2.2 and not low_streak:
        return prediction, "Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©", "Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙŠØ´ÙŠØ± Ø¥Ù„Ù‰ ÙØ±ØµØ© Ù‚ÙˆÙŠØ©"
    elif high_jump:
        return prediction, "Ø§Ù†ØªØ¸Ø± Ø¬ÙˆÙ„ØªÙŠÙ† ÙˆØ§Ø¯Ø®Ù„", "Ø¨Ø¹Ø¯ Ù‚ÙØ²Ø© Ø¹Ø§Ù„ÙŠØ©ØŒ ØºØ§Ù„Ø¨Ù‹Ø§ ÙŠØ­Ø¯Ø« Ø§Ù†Ø®ÙØ§Ø¶"
    else:
        return prediction, "Ù„Ø§ ØªØ¯Ø®Ù„ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©", "Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ Ø¶Ø¹ÙŠÙ ÙˆØ§Ù„Ø®Ø·Ø± Ù…Ø±ØªÙØ¹"

@bot.message_handler(commands=['start'])
def start_handler(message):
    user_data[message.chat.id] = []
    bot.send_message(message.chat.id, "Ø£Ø±Ø³Ù„ Ù†ØªØ§Ø¦Ø¬ Ù„Ø¹Ø¨Ø© Crash ÙˆØ§Ø­Ø¯Ø© ØªÙ„Ùˆ Ø§Ù„Ø£Ø®Ø±Ù‰.\nØ¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ 10 Ù†ØªØ§Ø¦Ø¬ØŒ Ø³ÙŠØªÙ… Ø¥Ø¹Ø·Ø§Ø¤Ùƒ Ø§Ù„ØªÙˆÙ‚Ø¹.")

@bot.message_handler(func=lambda message: True)
def result_handler(message):
    try:
        val = float(message.text.replace(",", "."))
    except ValueError:
        bot.send_message(message.chat.id, "ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… ØµØ§Ù„Ø­ (Ù…Ø«Ø§Ù„: 1.23)")
        return

    user_data.setdefault(message.chat.id, []).append(val)

    if len(user_data[message.chat.id]) < 10:
        bot.send_message(message.chat.id, f"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø±Ù‚Ù… {len(user_data[message.chat.id])}/10. Ø£Ø±Ø³Ù„ Ø§Ù„ØªØ§Ù„ÙŠØ©.")
    else:
        history = user_data[message.chat.id]
        prediction, decision, reason = predict_next(history)
        bot.send_message(message.chat.id, f"""ğŸ“Š ØªÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„:
Ø§Ù„ØªÙˆÙ‚Ø¹ Ø§Ù„Ù‚Ø§Ø¯Ù…: {round(prediction, 2)}
Ø§Ù„Ù‚Ø±Ø§Ø±: {decision}
Ø§Ù„Ø³Ø¨Ø¨: {reason}""")
        user_data[message.chat.id] = []

bot.polling()
